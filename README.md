# 草莓温室环境分析与智能控制项目 (增强版)

## 1. 项目概述

本项目旨在利用机器学习和强化学习技术，对草莓温室的环境数据进行分析、预测和智能控制。项目代码 `experiment_code.py` 包含四个核心部分：
1.  **数据预处理**: 清洗和处理原始温室环境数据集。
2.  **时间序列预测**: 使用基于PyTorch实现的GCBS（CNN-BiGRU-Attention）模型，预测未来的关键环境指标。
3.  **最优控制策略**: 构建一个马尔可夫决策过程（MDP），并使用值迭代算法求解，为温室管理提供最优的控制建议。
4.  **闭环控制演示**: 将预测模型与控制策略集成，模拟一个 "感知-预测-决策-执行" 的自动化控制流程。

---

## 2. 项目文件结构

```text
strawberry/
├── experiment_code.py                                      # 主程序代码 (包含预处理、预测、控制逻辑)
├── Strawberry Greenhouse Environmental Control Dataset(version2).csv  # 数据集文件
├── README.md                                               # 项目说明文档
└── .gitignore                                              # Git 忽略配置文件
```

---

## 3. 数据集

本项目使用的数据集为 `Strawberry Greenhouse Environmental Control Dataset(version2).csv`，其中包含了温室的内外环境指标，如温度、湿度、CO2浓度等。

---

## 4. 代码结构 (`experiment_code.py`)

脚本分为四个主要部分，按顺序执行。

### 第一部分：数据加载与预处理

此部分负责将原始的CSV数据转换为可用于模型训练的格式。
- **加载数据**: 使用 `pandas` 加载CSV文件，并正确处理编码、分隔符和日期格式。
- **数据清洗**: 将所有数据列转换为数值类型。
- **时间序列重采样**: 将数据按30分钟的间隔进行重采样，并使用均值聚合。
- **缺失值填充**: 使用前向和后向填充方法，确保数据无缺失。
- **中文显示设置**: 配置 `matplotlib` 以正确显示中文字符和负号。

### 第二部分：基于GCBS模型的时间序列预测

此部分构建并训练一个深度学习模型，以预测温室内的关键环境指标。
- **数据归一化**: 使用 `MinMaxScaler` 将数据缩放到 `[0, 1]` 区间。
- **创建时间序列样本**: 使用过去12小时（24个时间点）的数据作为输入，预测下一个时间点的环境指标。
- **模型架构 (GCBS)**:
    - **Conv1D层**: 捕捉局部模式。
    - **BiGRU层**: 学习长期依赖关系。
    - **Self-Attention机制**: 对序列信息进行加权，关注关键时间点。
- **训练与评估**:
    - 将数据划分为训练集（80%）和测试集（20%）。
    - 在测试集上评估模型性能，并计算均方误差（MSE）和平均绝对误差（MAE）。
- **结果可视化**: 绘制训练损失曲线和预测值与真实值的对比图。

### 第三部分：基于MDP的最优控制策略

此部分将温室管理抽象为一个马尔可夫决策过程（MDP），以寻找长期收益最大化的最优策略。
- **状态空间 (States)**: 定义了9种离散的温室状态（如 "理想状态", "过热" 等）。
- **动作空间 (Actions)**: 定义了两种动作："维持现状 (Wait)" 和 "主动干预 (Act)"。
- **转移概率与奖励**: 基于论文或经验数据，为每个“状态-动作”对定义了概率和奖励/成本。
- **值迭代算法**: 迭代求解每个状态的长期价值，直至收敛。
- **最优策略**: 根据最终的价值函数，为每个状态推导出最优动作，并用热力图可视化。

### **第四部分：智能温室闭环控制系统演示**

这是项目的集成部分，它将预测模型与决策模型连接起来，模拟一个真实的自动化控制循环。
- **随机抽样**: 从测试集中随机抽取样本，模拟实时传入的连续环境数据。
- **预测未来**: 使用训练好的GCBS模型对每个样本进行预测，得到对未来环境的量化预判。
- **状态判定**: 根据预设的物理阈值（例如，温度 > 30°C），将连续的预测值（如温度、湿度）映射到MDP中定义的离散状态（如“过热”）。
- **查询决策**: 根据判定出的当前状态，从第三部分计算出的最优策略表中直接查询出应执行的最佳动作（“维持”或“干预”）。
- **生成报告**: 在控制台打印出整个“预测-判定-决策”的流程日志，直观展示系统如何自动响应环境变化。

---

## 5. 如何运行

### 4.1. 环境设置 (使用 Anaconda)
为了避免依赖库冲突，强烈建议使用`conda`虚拟环境。
```bash
# (如果有名为 strawberry_v2 的旧环境，建议先删除)
# conda env remove -n strawberry_v2

# 创建一个新的 conda 环境 (例如，名为 strawberry_env)
conda create -n strawberry_env python=3.10 -y

# 激活该环境
conda activate strawberry_env
```

### 4.2. 安装依赖
激活`conda`环境后，运行以下命令安装所有必需的库：
```bash
pip install pandas numpy torch scikit-learn matplotlib seaborn
```

### 4.3. 执行脚本
确保 `experiment_code.py` 和数据集文件 `Strawberry Greenhouse Environmental Control Dataset(version2).csv` 在同一目录下，然后运行：
```bash
python experiment_code.py
```

---

## 5. 常见问题 (Troubleshooting)

**问题**: 运行脚本时出现 `ModuleNotFoundError: No module named 'seaborn'` (或 `torch`, `sklearn` 等) 的错误。

**原因**: 这通常是因为您没有在正确的Python环境中安装依赖库。例如，您可能在系统的基础(base)环境中安装了库，但运行脚本时使用的是一个独立的`conda`虚拟环境。

**解决方案**:
1.  **确认您已激活正确的`conda`环境**。在终端中，您应该能看到环境名，例如 `(strawberry_env) C:\...`。
2.  **在激活的环境中安装**。执行 `pip install seaborn` 或 `conda install seaborn`。
3.  **如果问题仍然存在**，可以使用 `python -m pip install seaborn` 这种形式，它能确保为当前正在使用的 `python` 版本安装库。

---

## 6. 依赖库列表

- `pandas`
- `numpy`
- `torch` (PyTorch)
- `scikit-learn`
- `matplotlib`
- `seaborn`